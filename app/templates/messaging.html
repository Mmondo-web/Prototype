<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Messaging</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
.message-item {
    border-left: 4px solid #007bff;
    padding: 12px;
    margin-bottom: 12px;
    background-color: #f8f9fa;
    border-radius: 8px;
    position: relative;
}
.message-item.unread {
    border-left-color: #dc3545;
    background-color: #fff3cd;
}
.message-item.sent {
    border-left-color: #28a745;
    background-color: #eafaf1;
}
.delete-message {
    position: absolute;
    top: 8px;
    right: 8px;
    color: #dc3545;
    cursor: pointer;
    opacity: 0.5;
}
.delete-message:hover { opacity: 1; }

.conversation-panel {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    height: 400px;
    overflow-y: auto;
}
.list-group-item.unread {
    background-color: #e7f1ff;
}
</style>
</head>

<body>
<div class="container-fluid mt-4">
<div class="row">

<!-- SIDEBAR -->
<div class="col-md-4">
<div class="card">
<div class="card-header d-flex justify-content-between align-items-center">
<h5 class="mb-0">Conversations</h5>
<span class="badge bg-danger" id="unreadCount">0</span>
</div>
<div class="list-group list-group-flush" id="conversationsList"></div>
</div>
</div>

<!-- CHAT -->
<div class="col-md-8">
<div class="card">
<div class="card-header">
<h5 id="conversationTitle">Select a conversation</h5>
</div>

<div class="card-body">
<div id="messagesDisplay" class="conversation-panel mb-3"></div>

<div id="replyForm" style="display:none;">
<form id="sendMessageForm">
<input type="hidden" id="receiverId">
<input type="hidden" id="bookingId">
<div class="input-group">
<input type="text" id="replyContent" class="form-control" placeholder="Type your message..." required>
<button class="btn btn-primary">Send</button>
</div>
</form>
</div>

</div>
</div>
</div>

</div>
</div>

<script>
let currentConversation = null;
let currentUserId = {{ current_user.id }};

/* ================= API HELPER ================= */
async function apiFetch(url, options = {}) {
    return fetch(url, {
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        ...options
    });
}

/* ================= INITIAL LOAD ================= */
document.addEventListener('DOMContentLoaded', () => {
    loadConversations();
    loadUnreadCount();
    setInterval(loadUnreadCount, 30000);
    document.getElementById('sendMessageForm').addEventListener('submit', sendReply);
});

/* ================= UNREAD COUNT ================= */
async function loadUnreadCount() {
    const res = await apiFetch('/api/messages/unread/count');
    const data = await res.json();
    document.getElementById('unreadCount').textContent = data.unread_count || 0;
}

/* ================= LOAD CONVERSATIONS ================= */
async function loadConversations() {
    const res = await apiFetch('/api/messages/conversations');
    const conversations = await res.json();
    const list = document.getElementById('conversationsList');
    list.innerHTML = '';

    conversations.forEach(conv => {
        const item = document.createElement('a');
        item.href = '#';
        item.className = `list-group-item list-group-item-action ${conv.unread_count > 0 ? 'unread' : ''}`;
        item.innerHTML = `
            <div class="d-flex justify-content-between">
                <strong>${conv.other_user_name}</strong>
                <small>${formatTime(conv.last_message_time)}</small>
            </div>
            <div class="small text-truncate">${conv.last_message}</div>
            ${conv.unread_count > 0 ? `<span class="badge bg-danger">${conv.unread_count}</span>` : ''}
        `;
        item.onclick = (e) => {
            e.preventDefault();
            openConversation(conv.other_user_id, conv.booking_id);
        };
        list.appendChild(item);
    });
}

/* ================= OPEN CONVERSATION ================= */
async function openConversation(otherUserId, bookingId = null) {
    currentConversation = { otherUserId, bookingId };

    let url = `/api/messages/conversation/${otherUserId}`;
    if (bookingId) url += `?booking_id=${bookingId}`;

    const res = await apiFetch(url);
    const messages = await res.json();

    const display = document.getElementById('messagesDisplay');
    display.innerHTML = '';

    if (!messages.length) return;

    const otherUserName = messages.find(m => m.sender_id !== currentUserId)?.sender_name || 'User';
    document.getElementById('conversationTitle').innerHTML =
        `Conversation with <strong>${otherUserName}</strong>`;

    document.getElementById('replyForm').style.display = 'block';
    document.getElementById('receiverId').value = otherUserId;
    document.getElementById('bookingId').value = bookingId || '';

    for (const msg of messages) {
        appendMessageToUI(msg);

        if (msg.receiver_id === currentUserId && msg.status === 'unread') {
            await apiFetch(`/api/messages/${msg.id}/read`, { method: 'PUT' });
        }
    }

    display.scrollTop = display.scrollHeight;
    loadUnreadCount();
    loadConversations();
}

/* ================= SEND REPLY ================= */
async function sendReply(e) {
    e.preventDefault();

    const receiverId = document.getElementById('receiverId').value;
    const bookingId = document.getElementById('bookingId').value;
    const content = document.getElementById('replyContent').value;

    if (!content.trim()) return;

    const newMessage = await sendMessage(receiverId, bookingId, null, content);
    if (!newMessage) return;

    document.getElementById('replyContent').value = '';
    appendMessageToUI(newMessage);
}

/* ================= SEND MESSAGE ================= */
async function sendMessage(receiverId, bookingId, subject, content) {
    const res = await apiFetch('/api/messages/', {
        method: 'POST',
        body: JSON.stringify({
            receiver_id: parseInt(receiverId),
            booking_id: bookingId ? parseInt(bookingId) : null,
            subject: subject || null,
            content: content
        })
    });

    if (res.ok) {
        const newMessage = await res.json();
        loadConversations();
        loadUnreadCount();
        return newMessage;
    } else {
        const error = await res.json();
        alert(error.detail || "Send failed");
        return null;
    }
}

/* ================= APPEND MESSAGE ================= */
function appendMessageToUI(msg) {
    const display = document.getElementById('messagesDisplay');

    const div = document.createElement('div');
    div.className = `message-item ${msg.sender_id === currentUserId ? 'sent' : ''} 
                     ${msg.status === 'unread' && msg.receiver_id === currentUserId ? 'unread' : ''}`;

    div.innerHTML = `
        ${msg.sender_id === currentUserId ? `
            <span class="delete-message" onclick="deleteMessage(${msg.id})">
                <i class="fas fa-trash"></i>
            </span>
        ` : ''}

        <div class="d-flex justify-content-between">
            <strong>${msg.sender_name}</strong>
            <small>${new Date(msg.created_at).toLocaleString()}</small>
        </div>

        ${msg.subject ? `<h6>${msg.subject}</h6>` : ''}
        <p>${msg.content}</p>
    `;

    display.appendChild(div);
    display.scrollTop = display.scrollHeight;
}

/* ================= DELETE ================= */
async function deleteMessage(messageId) {
    if (!confirm("Delete this message?")) return;

    await apiFetch(`/api/messages/${messageId}`, { method: 'DELETE' });

    if (currentConversation) {
        openConversation(currentConversation.otherUserId, currentConversation.bookingId);
    }
}

window.deleteMessage = deleteMessage;

/* ================= TIME FORMAT ================= */
function formatTime(datetime) {
    if (!datetime) return '';
    const date = new Date(datetime);
    const diff = (new Date() - date) / 60000;
    if (diff < 60) return Math.round(diff) + " min ago";
    if (diff < 1440) return Math.round(diff / 60) + " hrs ago";
    return date.toLocaleDateString();
}
</script>

</body>
</html>
